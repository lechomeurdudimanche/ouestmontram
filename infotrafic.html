<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script>
        function setAppHeight() {
            document.documentElement.style.setProperty('--app-height', window.innerHeight + 'px');
        }
        setAppHeight();
        window.addEventListener('resize', setAppHeight);
    </script>
    <title>Infotrafic - O√π est mon tram ?</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-hover: #2d2d2d;
            --text-main: #f5f5f5;
            --text-muted: #a0a0a0;
            --border: #333;
            --realtime: #4caf50;
            --theoretical: #ff9800;
            --radar-color: #00d2ff;
            --radar-at-stop: #ffd700;
            
            --color-a: #006eb7;
            --color-b: #00a459;
            --color-c: #e2007a;
            --color-d: #f29400;
            --color-e: #5c2a90;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: var(--app-height, 100vh);
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 60px;
        }

        .empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            padding: 40px 20px;
            text-align: center;
        }

        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            z-index: 1000;
        }

        .nav-buttons {
            display: flex;
            height: 100%;
        }

        .nav-link {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            text-decoration: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            transition: all 0.2s;
            position: relative;
        }

        .nav-link:hover {
            background: var(--bg-hover);
        }

        .nav-link.active {
            color: var(--radar-color);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--radar-color);
        }

        .nav-icon {
            font-size: 1.3rem;
        }
    </style>
</head>
<body>
    <div id="content">
        <div class="empty">Chargement des perturbations...</div>
    </div>

    <div id="bottom-nav">
        <div class="nav-buttons">
            <a href="index.html" class="nav-link">
                <span class="nav-icon">üïê</span>
                <span>Horaires</span>
            </a>
            <a href="suivi.html" class="nav-link">
                <span class="nav-icon">üöã</span>
                <span>Suivi</span>
            </a>
            <a href="infotrafic.html" class="nav-link active">
                <span class="nav-icon">‚ö†Ô∏è</span>
                <span>Infotrafic</span>
            </a>
        </div>
    </div>

    <script>
        const app = {
            async init() {
                await this.loadDisruptions();
            },

            async loadDisruptions() {
                try {
                    const response = await fetch('https://data.mobilites-m.fr/api/dyn/evtTC/json');
                    const data = await response.json();
                    
                    if (!data || Object.keys(data).length === 0) {
                        document.getElementById('content').innerHTML = `
                            <div class="empty">
                                <div style="font-size: 1.2rem; margin-bottom: 10px;">‚úì Trafic normal</div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">Aucune perturbation signal√©e</div>
                            </div>
                            <footer style="font-size: 0.7rem; color: var(--text-muted); text-align: center; padding: 10px;">
                                Donn√©es : <a href="https://data.mobilites-m.fr/" target="_blank" style="color: var(--radar-color);">Mobilit√©s M</a> 
                                | <a href="mentions.html" style="color: var(--text-muted);">Mentions l√©gales & Licence</a>
                            </footer>`;
                        return;
                    }

                    const now = new Date();
                    const parseDate = (dateStr) => {
                        const [date, time] = dateStr.split(' ');
                        const [day, month, year] = date.split('/');
                        const [hour, minute] = time.split(':');
                        return new Date(year, month - 1, day, hour, minute);
                    };
                    
                    const formatDate = (dateStr) => {
                        try {
                            const [date, time] = dateStr.split(' ');
                            const [day, month, year] = date.split('/');
                            const [hour, minute] = time.split(':');
                            return `${day}/${month}/${year} ${hour}:${minute}`;
                        } catch (e) {
                            return dateStr;
                        }
                    };
                    
                    const allDisruptions = Object.values(data).filter(d => {
                        const listeLigne = d.listeLigne || '';
                        const isTram = /^SEM[_:]([ABCDE])$/.test(listeLigne);
                        
                        try {
                            const endDate = parseDate(d.dateFin);
                            const notExpired = now <= endDate;
                            return isTram && d.visibleTC && notExpired;
                        } catch (e) {
                            return false;
                        }
                    });

                    const currentDisruptions = [];
                    const futureDisruptions = [];
                    
                    allDisruptions.forEach(d => {
                        try {
                            const startDate = parseDate(d.dateDebut);
                            if (now >= startDate) {
                                currentDisruptions.push(d);
                            } else {
                                futureDisruptions.push(d);
                            }
                        } catch (e) {
                            currentDisruptions.push(d);
                        }
                    });

                    if (currentDisruptions.length === 0 && futureDisruptions.length === 0) {
                        document.getElementById('content').innerHTML = `
                            <div class="empty">
                                <div style="font-size: 1.2rem; margin-bottom: 10px;">‚úì Trafic normal</div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">Aucune perturbation sur les trams</div>
                            </div>
                            <footer style="font-size: 0.7rem; color: var(--text-muted); text-align: center; padding: 10px;">
                                Donn√©es : <a href="https://data.mobilites-m.fr/" target="_blank" style="color: var(--radar-color);">Mobilit√©s M</a> 
                                | <a href="mentions.html" style="color: var(--text-muted);">Mentions l√©gales & Licence</a>
                            </footer>`;
                        return;
                    }

                    const lineColors = {
                        'A': '#006eb7',
                        'B': '#00a459',
                        'C': '#e2007a',
                        'D': '#f29400',
                        'E': '#5c2a90'
                    };

                    const cleanAndFormatText = (text) => {
                        if (!text) return '';
                        
                        let cleaned = text.replace(/<[^>]*>/g, '');
                        
                        cleaned = cleaned.replace(/\r\n/g, ' ').replace(/\r/g, ' ').replace(/\n/g, ' ');
                        
                        cleaned = cleaned.trim();
                        
                        cleaned = cleaned.replace(/^[√†√Äa]\s+partir\s+du\s+\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}\s*\|\s*[Jj]usqu['\u2019\u0027]au\s+\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}\s*/gi, '');
                        cleaned = cleaned.replace(/^[Jj]usqu['\u2019\u0027]au\s+\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}\s*\|\s*[√†√Äa]\s+partir\s+du\s+\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}\s*/gi, '');
                        
                        cleaned = cleaned.replace(/^[Jj]usqu['\u2019\u0027]au\s+\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}\s+\d{1,2}:\d{2}\s*/g, '');
                        cleaned = cleaned.replace(/^[Jj]usqu['\u2019\u0027]au\s+\d{1,2}\s+\w+\s+\d{1,2}h\d{2}\s*/gi, '');
                        
                        cleaned = cleaned.replace(/^[A√Äa]\s+partir\s+du\s+\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}\s+\d{1,2}:\d{2}\s*/gi, '');
                        cleaned = cleaned.replace(/^[A√Äa]\s+partir\s+du\s+\d{1,2}\s+\w+\s+\d{1,2}h\d{2}\s*/gi, '');
                        
                        cleaned = cleaned.replace(/^[Dd]u\s+\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}\s+\d{1,2}:\d{2}\s+au\s+\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4}\s+\d{1,2}:\d{2}\s*/g, '');
                        cleaned = cleaned.replace(/^[Dd]u\s+\d{1,2}\s+\w+\s+\d{1,2}h\d{2}\s+au\s+\d{1,2}\s+\w+\s+\d{1,2}h\d{2}\s*/gi, '');
                        
                        cleaned = cleaned.replace(/^\s*\|+\s*/g, '').replace(/\s*\|+$/g, '');
                        cleaned = cleaned.replace(/\|/g, '');
                        
                        cleaned = cleaned.replace(/\s+/g, ' ').trim();
                        
                        if (!cleaned) return '';
                        
                        cleaned = cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
                        
                        cleaned = cleaned.replace(/\.\s+([A-Z])/g, '.<br>$1');
                        
                        return cleaned;
                    };

                    const formatDisruption = (disruption) => {
                        const ligne = disruption.listeLigne ? disruption.listeLigne.replace('SEM_', '').replace('SEM:', '') : '';
                        const lineColor = lineColors[ligne] || '#888';
                        
                        let titre = disruption.titre || 'Perturbation en cours';
                        titre = titre.charAt(0).toUpperCase() + titre.slice(1);
                        
                        const description = disruption.description || disruption.texte || '';
                        const formattedDescription = cleanAndFormatText(description);
                        
                        const dateDebut = formatDate(disruption.dateDebut);
                        const dateFin = formatDate(disruption.dateFin);
                        
                        const showDateRange = !dateFin.includes('2050');

                        return `
                            <div style="display: flex; gap: 12px; background: var(--bg-hover); padding: 12px; margin-bottom: 12px; border-radius: 8px; border-left: 3px solid ${lineColor};">
                                <div style="flex-shrink: 0;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background-color: ${lineColor}; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.3rem; color: white;">
                                        ${ligne}
                                    </div>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; margin-bottom: 6px; font-size: 0.95rem; color: var(--text-main);">
                                        ${titre}
                                    </div>
                                    <div style="font-size: 0.75rem; color: #00d2ff; margin-bottom: 8px;">
                                        üìÖ ${showDateRange ? `Du ${dateDebut} au ${dateFin}` : `Depuis le ${dateDebut}`}
                                    </div>
                                    <div style="font-size: 0.85rem; line-height: 1.6; color: var(--text-muted); word-wrap: break-word;">
                                        ${formattedDescription}
                                    </div>
                                    ${disruption.plan ? `<div style="margin-top: 8px;"><a href="${disruption.plan}" target="_blank" style="color: #00d2ff; font-size: 0.8rem; text-decoration: none;">üìÑ Plus d'infos</a></div>` : ''}
                                </div>
                            </div>`;
                    };

                    let html = '<div style="padding: 15px;">';
                    
                    html += '<div style="text-align: center; font-size: 1.4rem; font-weight: 700; color: white; margin-bottom: 20px;">Infotrafic :</div>';
                    
                    if (currentDisruptions.length > 0) {
                        html += '<div style="font-size: 1.2rem; margin-bottom: 15px; font-weight: 600; color: #ff9800;">‚ö†Ô∏è Perturbations en cours</div>';
                        currentDisruptions.forEach(disruption => {
                            html += formatDisruption(disruption);
                        });
                    }
                    
                    if (futureDisruptions.length > 0) {
                        if (currentDisruptions.length > 0) {
                            html += '<div style="height: 1px; background: var(--border); margin: 20px 0;"></div>';
                        }
                        html += '<div style="font-size: 1.2rem; margin-bottom: 15px; font-weight: 600; color: #2196f3;">üìÖ Perturbations pr√©vues</div>';
                        futureDisruptions.forEach(disruption => {
                            html += formatDisruption(disruption);
                        });
                    }
                    
                    html += '</div>';
                    
                    html += `
                        <footer style="font-size: 0.7rem; color: var(--text-muted); text-align: center; padding: 10px;">
                            Donn√©es : <a href="https://data.mobilites-m.fr/" target="_blank" style="color: var(--radar-color);">Mobilit√©s M</a> 
                            | <a href="mentions.html" style="color: var(--text-muted);">Mentions l√©gales & Licence</a>
                        </footer>
                    `;
                    
                    document.getElementById('content').innerHTML = html;
                    
                } catch (error) {
                    console.error('Erreur lors du chargement des perturbations:', error);
                    document.getElementById('content').innerHTML = `
                        <div class="empty">Erreur de chargement des perturbations</div>`;
                }
            }
        };

        document.addEventListener("DOMContentLoaded", () => app.init());
    </script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/ouestmontram/sw.js")
    .then(() => console.log("Service Worker enregistr√©"));
}
</script>
</body>
</html>